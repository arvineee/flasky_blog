{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Post Card -->
            <article class="card shadow-sm mb-4">
                <!-- Post Header -->
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>{{ post.date_pub.strftime('%B %d, %Y') }}
                            </small>
                            {% if post.category_obj %}
                            <span class="badge bg-primary ms-2">{{ post.category_obj.name }}</span>
                            {% endif %}
                        </div>
                        {% if current_user.is_authenticated and (current_user == post.author or current_user.is_admin) %}
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{{ url_for('admin.edit_post', post_id=post.id) }}">
                                    <i class="fas fa-edit me-2"></i>Edit
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form action="{{ url_for('main.delete_post', post_id=post.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this post?');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="dropdown-item text-danger">
                                            <i class="fas fa-trash me-2"></i>Delete
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Post Body -->
                <div class="card-body">
                    <!-- Title -->
                    <h1 class="card-title display-6 fw-bold mb-4">{{ post.title }}</h1>

                    <!-- Author Info -->
                    <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
                        <img src="{{ post.author.get_avatar_url(size=50) }}" 
                             alt="{{ post.author.username }}" 
                             class="rounded-circle me-3" 
                             style="width: 50px; height: 50px;">
                        <div>
                            <h6 class="mb-0">{{ post.author.username }}</h6>
                            <small class="text-muted">
                                <i class="fas fa-eye me-1"></i>{{ post.views }} views
                                <span class="mx-2">â€¢</span>
                                <i class="fas fa-comment me-1"></i>{{ post.comment_count }} comments
                            </small>
                        </div>
                    </div>

                    <!-- Featured Image (if exists) -->
                    {% if post.image_url %}
                    <div class="post-image mb-4">
                        <img src="{{ url_for('static', filename='images/' + post.image_url) }}" 
                             alt="{{ post.title }}" 
                             class="img-fluid rounded shadow-sm w-100"
                             style="max-height: 500px; object-fit: cover;">
                    </div>
                    {% endif %}

                    <!-- Video Player (if video exists) -->
                    {% if post.video_url %}
                    <div class="post-video mb-4">
                        <div class="video-wrapper position-relative rounded overflow-hidden shadow-sm">
                            <video class="custom-video w-100" 
                                   controls 
                                   preload="metadata" 
                                   poster="{% if post.image_url %}{{ url_for('static', filename='images/' + post.image_url) }}{% endif %}">
                                <source src="{{ url_for('static', filename='videos/' + post.video_url) }}" type="video/mp4">
                                <source src="{{ url_for('static', filename='videos/' + post.video_url) }}" type="video/webm">
                                Your browser does not support the video tag.
                            </video>
                            
                            <!-- Video Controls Overlay -->
                            <div class="video-controls-overlay position-absolute bottom-0 start-0 end-0 p-3 bg-gradient">
                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn btn-light btn-sm" id="playPauseBtn">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <div class="flex-grow-1 mx-3">
                                        <input type="range" class="form-range" id="seekBar" value="0" step="0.1">
                                    </div>
                                    <button class="btn btn-light btn-sm" id="muteBtn">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                    <button class="btn btn-light btn-sm ms-2" id="fullscreenBtn">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Post Content -->
                    <div class="post-content mb-4">
                        {{ post.desc|safe }}
                    </div>

                    <!-- Post Actions -->
                    <div class="post-actions d-flex justify-content-between align-items-center py-3 border-top border-bottom">
                        <div class="d-flex gap-2">
                            {% if current_user.is_authenticated %}
                            <!-- Like Button -->
                            <button class="btn btn-outline-danger btn-like" data-post-id="{{ post.id }}">
                                <i class="far fa-heart"></i>
                                <span class="like-count">{{ post.like_count }}</span> Likes
                            </button>
                            {% else %}
                            <!-- Login to Like -->
                            <a href="{{ url_for('main.login') }}" class="btn btn-outline-danger">
                                <i class="far fa-heart"></i>
                                <span>{{ post.like_count }}</span> Likes
                            </a>
                            {% endif %}
                            
                            <!-- Comment Button -->
                            <button class="btn btn-outline-primary" onclick="document.getElementById('commentSection').scrollIntoView({behavior: 'smooth'});">
                                <i class="far fa-comment"></i>
                                Comment
                            </button>
                        </div>
                        
                        <!-- Share Button -->
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-share-alt"></i> Share
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" target="_blank">
                                    <i class="fab fa-facebook text-primary"></i> Facebook
                                </a></li>
                                <li><a class="dropdown-item" href="https://twitter.com/intent/tweet?url={{ request.url }}&text={{ post.title }}" target="_blank">
                                    <i class="fab fa-twitter text-info"></i> Twitter
                                </a></li>
                                <li><a class="dropdown-item" href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.url }}&title={{ post.title }}" target="_blank">
                                    <i class="fab fa-linkedin text-primary"></i> LinkedIn
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="copyToClipboard('{{ request.url }}'); return false;">
                                    <i class="fas fa-link"></i> Copy Link
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </article>

            <!-- Comments Section with AJAX -->
            <div class="card shadow-sm" id="commentSection">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>Comments (<span class="comment-count">{{ post.comment_count }}</span>)
                    </h5>
                </div>
                <div class="card-body">
                    {% if current_user.is_authenticated %}
                    <!-- Add Comment Form - AJAX -->
                    <form id="commentForm" class="mb-4">
                        <div class="d-flex gap-3">
                            <img src="{{ current_user.get_avatar_url(size=40) }}" 
                                 alt="{{ current_user.username }}" 
                                 class="rounded-circle" 
                                 style="width: 40px; height: 40px;">
                            <div class="flex-grow-1">
                                <textarea id="commentTextarea" 
                                          class="form-control" 
                                          placeholder="Share your thoughts..." 
                                          rows="3" 
                                          maxlength="1000"
                                          required></textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">
                                        <span id="charCounter">0/1000</span> characters
                                    </small>
                                    <button type="submit" 
                                            id="commentSubmitBtn" 
                                            class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i>Post Comment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <!-- Not logged in message -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Please <a href="{{ url_for('main.login') }}" class="alert-link">login</a> to leave a comment.
                    </div>
                    {% endif %}

                    <!-- Comments List - Loaded via AJAX -->
                    <div id="commentsList">
                        <!-- Comments will be loaded here via AJAX -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading comments...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading comments...</p>
                        </div>
                    </div>
                    
                    <!-- Comments Pagination -->
                    <div id="commentsPagination" class="d-flex justify-content-center mt-3">
                        <!-- Pagination will be loaded here via AJAX -->
                    </div>
                </div>
            </div>

            <!-- Comment Moderation Modal (for flagging with reason) -->
            <div class="modal fade" id="flagModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-flag me-2 text-warning"></i>Flag Comment
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="flagForm">
                                <input type="hidden" id="flagCommentId">
                                <div class="mb-3">
                                    <label for="flagReason" class="form-label">Reason for flagging:</label>
                                    <select class="form-select" id="flagReason" required>
                                        <option value="" selected disabled>Select a reason</option>
                                        <option value="Inappropriate content">Inappropriate content</option>
                                        <option value="Spam or advertising">Spam or advertising</option>
                                        <option value="Harassment or bullying">Harassment or bullying</option>
                                        <option value="Hate speech">Hate speech</option>
                                        <option value="False information">False information</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="customReasonDiv" style="display: none;">
                                    <label for="customReason" class="form-label">Custom reason:</label>
                                    <input type="text" class="form-control" id="customReason" 
                                           placeholder="Please specify...">
                                </div>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Flagged comments will be reviewed by administrators.
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-warning" onclick="submitFlag()">
                                <i class="fas fa-flag me-1"></i>Flag Comment
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comment Edit Modal -->
            <div class="modal fade" id="editModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-edit me-2 text-primary"></i>Edit Comment
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editForm">
                                <input type="hidden" id="editCommentId">
                                <div class="mb-3">
                                    <textarea class="form-control" id="editCommentText" 
                                              rows="4" maxlength="1000" required></textarea>
                                    <div class="mt-2 text-end">
                                        <small class="text-muted">
                                            <span id="editCharCounter">0/1000</span> characters
                                        </small>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitEdit()">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Author Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center">
                    <img src="{{ post.author.get_avatar_url(size=80) }}" 
                         alt="{{ post.author.username }}" 
                         class="rounded-circle mb-3" 
                         style="width: 80px; height: 80px;">
                    <h5 class="card-title">{{ post.author.username }}</h5>
                    <p class="text-muted small">Author</p>
                </div>
            </div>

            <!-- Recommended Posts -->
            {% if recommended_posts %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="fas fa-newspaper me-2"></i>Recommended Posts
                    </h6>
                </div>
                <div class="list-group list-group-flush">
                    {% for rec_post in recommended_posts %}
                    <a href="{{ rec_post.url }}" class="list-group-item list-group-item-action">
                        <div class="d-flex">
                            {% if rec_post.image_url %}
                            <img src="{{ url_for('static', filename='images/' + rec_post.image_url) }}" 
                                 alt="{{ rec_post.title }}" 
                                 class="rounded me-3" 
                                 style="width: 60px; height: 60px; object-fit: cover;">
                            {% endif %}
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ rec_post.title|truncate(50) }}</h6>
                                <small class="text-muted">{{ rec_post.desc|truncate(60) }}</small>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Ads -->
            {% if ads %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <small class="text-muted">Sponsored</small>
                </div>
                <div class="card-body">
                    {% for ad in ads %}
                    <div class="ad-container mb-3">
                        {{ ad.content|safe }}
                        <div class="mt-2 text-end">
                            <a href="{{ url_for('main.track_ad_click', ad_id=ad.id) }}" 
                               class="btn btn-sm btn-outline-primary" 
                               target="_blank">
                                Learn More
                            </a>
                        </div>
                    </div>
                    {% if not loop.last %}<hr>{% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Admin Moderation Panel (only for admins) -->
{% if current_user.is_authenticated and current_user.is_admin %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h6 class="mb-0">
                <i class="fas fa-shield-alt me-2"></i>Admin: Comment Moderation
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-flag fa-2x text-warning mb-2"></i>
                            <h6 class="mb-0">Flagged Comments</h6>
                            <p class="mb-0 text-muted" id="flaggedCount">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-eye-slash fa-2x text-danger mb-2"></i>
                            <h6 class="mb-0">Hidden Comments</h6>
                            <p class="mb-0 text-muted" id="hiddenCount">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-comments fa-2x text-primary mb-2"></i>
                            <h6 class="mb-0">Total Comments</h6>
                            <p class="mb-0 text-muted comment-count">{{ post.comment_count }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info mt-3 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Admin Tools:</strong> Use the dropdown menu on each comment to flag, hide, or moderate content.
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.post-content {
    font-size: 1.1rem;
    line-height: 1.8;
}

.post-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 20px 0;
}

.post-content h2, .post-content h3 {
    margin-top: 30px;
    margin-bottom: 15px;
}

.video-wrapper {
    background: #000;
}

.video-controls-overlay {
    background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
}

.animate-like {
    animation: likeAnimation 0.3s ease;
}

@keyframes likeAnimation {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.btn-like.liked i {
    color: #dc3545 !important;
}

.comment {
    transition: background-color 0.2s;
}

.comment:hover {
    background-color: #f8f9fa;
}

.comment-flagged {
    background-color: #fff3cd !important;
    border-left: 4px solid #ffc107;
}

.comment-hidden {
    background-color: #f8d7da !important;
    opacity: 0.8;
    border-left: 4px solid #dc3545;
}

.comment-edited {
    font-style: italic;
}

.comment-badge {
    font-size: 0.7rem;
    padding: 2px 6px;
    margin-left: 5px;
}

@media (max-width: 768px) {
    .post-content {
        font-size: 1rem;
    }
}
</style>

<script>
// Video Controls
document.addEventListener('DOMContentLoaded', function() {
    const video = document.querySelector('.custom-video');
    if (video) {
        const playPauseBtn = document.getElementById('playPauseBtn');
        const seekBar = document.getElementById('seekBar');
        const muteBtn = document.getElementById('muteBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');

        // Play/Pause
        if (playPauseBtn) {
            playPauseBtn.addEventListener('click', function() {
                if (video.paused) {
                    video.play();
                    this.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    video.pause();
                    this.innerHTML = '<i class="fas fa-play"></i>';
                }
            });
        }

        // Update seek bar
        video.addEventListener('timeupdate', function() {
            if (seekBar) {
                const value = (100 / video.duration) * video.currentTime;
                seekBar.value = value;
            }
        });

        // Seek
        if (seekBar) {
            seekBar.addEventListener('change', function() {
                const time = video.duration * (seekBar.value / 100);
                video.currentTime = time;
            });
        }

        // Mute/Unmute
        if (muteBtn) {
            muteBtn.addEventListener('click', function() {
                video.muted = !video.muted;
                this.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
            });
        }

        // Fullscreen
        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', function() {
                if (video.requestFullscreen) {
                    video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) {
                    video.webkitRequestFullscreen();
                } else if (video.msRequestFullscreen) {
                    video.msRequestFullscreen();
                }
            });
        }
    }

    // Initialize comments
    loadComments(1);
});

// Comment System Variables
let currentPage = 1;
const postId = {{ post.id }};
const userId = {% if current_user.is_authenticated %}{{ current_user.id }}{% else %}null{% endif %};
const isAdmin = {% if current_user.is_authenticated and current_user.is_admin %}true{% else %}false{% endif %};

// Load comments via AJAX
function loadComments(page = 1) {
    currentPage = page;
    const commentsList = document.getElementById('commentsList');
    commentsList.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading comments...</span>
            </div>
            <p class="mt-2 text-muted">Loading comments...</p>
        </div>
    `;

    fetch(`/api/comments/${postId}?page=${page}&per_page=10`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayComments(data.comments);
                displayPagination(data);
                updateCommentCount(data.total);
                
                // Update admin stats if admin
                if (isAdmin) {
                    updateAdminStats();
                }
            } else {
                commentsList.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading comments: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading comments:', error);
            commentsList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load comments. Please try again.
                </div>
            `;
        });
}

// Display comments
function displayComments(comments) {
    const commentsList = document.getElementById('commentsList');
    
    if (comments.length === 0) {
        commentsList.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                <p class="text-muted">No comments yet. Be the first to comment!</p>
            </div>
        `;
        return;
    }

    let html = '';
    comments.forEach(comment => {
        // Determine comment classes
        let commentClass = 'comment p-3 mb-3 rounded';
        if (comment.is_hidden) commentClass += ' comment-hidden';
        if (comment.is_flagged) commentClass += ' comment-flagged';
        
        // Determine action buttons based on user role
        let actionButtons = '';
        const isCommentOwner = userId === comment.user.id;
        
        if (userId) {
            actionButtons = `
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary" type="button" 
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
            `;
            
            // Owner actions
            if (isCommentOwner) {
                actionButtons += `
                    <li><a class="dropdown-item" href="#" onclick="showEditModal(${comment.id}, '${comment.content.replace(/'/g, "\\'")}')">
                        <i class="fas fa-edit me-2"></i>Edit
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                `;
            }
            
            // Admin actions
            if (isAdmin) {
                // Flag/Unflag
                if (comment.is_flagged) {
                    actionButtons += `
                        <li><a class="dropdown-item text-warning" href="#" onclick="performModeration(${comment.id}, 'unflag')">
                            <i class="fas fa-flag me-2"></i>Remove Flag
                        </a></li>
                    `;
                } else {
                    actionButtons += `
                        <li><a class="dropdown-item text-warning" href="#" onclick="showFlagModal(${comment.id})">
                            <i class="fas fa-flag me-2"></i>Flag Comment
                        </a></li>
                    `;
                }
                
                // Hide/Unhide
                if (comment.is_hidden) {
                    actionButtons += `
                        <li><a class="dropdown-item text-success" href="#" onclick="performModeration(${comment.id}, 'unhide')">
                            <i class="fas fa-eye me-2"></i>Unhide Comment
                        </a></li>
                    `;
                } else {
                    actionButtons += `
                        <li><a class="dropdown-item text-secondary" href="#" onclick="performModeration(${comment.id}, 'hide')">
                            <i class="fas fa-eye-slash me-2"></i>Hide Comment
                        </a></li>
                    `;
                }
                
                // Delete (admin)
                actionButtons += `
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteComment(${comment.id})">
                        <i class="fas fa-trash me-2"></i>Delete as Admin
                    </a></li>
                `;
            } else if (isCommentOwner) {
                // Delete (owner)
                actionButtons += `
                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteComment(${comment.id})">
                        <i class="fas fa-trash me-2"></i>Delete
                    </a></li>
                `;
            }
            
            actionButtons += `
                    </ul>
                </div>
            `;
        }
        
        // Badges for comment status
        let badges = '';
        if (comment.is_flagged) {
            badges += `<span class="badge bg-warning comment-badge">Flagged</span>`;
        }
        if (comment.is_hidden) {
            badges += `<span class="badge bg-danger comment-badge">Hidden</span>`;
        }
        if (comment.edited) {
            badges += `<span class="badge bg-info comment-badge">Edited</span>`;
        }
        
        html += `
            <div class="${commentClass}" id="comment-${comment.id}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="d-flex align-items-center">
                        <img src="${comment.user.avatar_url}" 
                             alt="${comment.user.username}" 
                             class="rounded-circle me-2" 
                             style="width: 32px; height: 32px;">
                        <div>
                            <strong class="me-2">${comment.user.username}</strong>
                            ${badges}
                        </div>
                    </div>
                    ${actionButtons}
                </div>
                
                <div class="comment-content mb-2">
                    ${comment.is_hidden ? 
                        '<em class="text-muted">[This comment has been hidden by a moderator]</em>' : 
                        comment.content}
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="far fa-clock me-1"></i>${comment.date_posted}
                        ${comment.edited_at ? 
                            `<span class="ms-2"><i class="fas fa-pencil-alt me-1"></i>Edited: ${comment.edited_at}</span>` : 
                            ''}
                    </small>
                    
                    ${comment.is_flagged && comment.flag_reason ? 
                        `<small class="text-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>Flagged: ${comment.flag_reason}
                        </small>` : 
                        ''}
                </div>
            </div>
        `;
    });
    
    commentsList.innerHTML = html;
}

// Display pagination
function displayPagination(data) {
    const paginationDiv = document.getElementById('commentsPagination');
    if (!data.pages || data.pages <= 1) {
        paginationDiv.innerHTML = '';
        return;
    }
    
    let html = `
        <nav aria-label="Comments pagination">
            <ul class="pagination">
    `;
    
    // Previous button
    html += `
        <li class="page-item ${!data.has_prev ? 'disabled' : ''}">
            <button class="page-link" ${data.has_prev ? `onclick="loadComments(${data.current_page - 1})"` : ''}>
                &laquo; Previous
            </button>
        </li>
    `;
    
    // Page numbers
    const totalPages = data.pages;
    const currentPage = data.current_page;
    const maxVisible = 5;
    
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage + 1 < maxVisible) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <button class="page-link" onclick="loadComments(${i})">${i}</button>
            </li>
        `;
    }
    
    // Next button
    html += `
        <li class="page-item ${!data.has_next ? 'disabled' : ''}">
            <button class="page-link" ${data.has_next ? `onclick="loadComments(${data.current_page + 1})"` : ''}>
                Next &raquo;
            </button>
        </li>
    `;
    
    html += `
            </ul>
        </nav>
    `;
    
    paginationDiv.innerHTML = html;
}

// Update comment count
function updateCommentCount(count) {
    const commentCountElements = document.querySelectorAll('.comment-count');
    commentCountElements.forEach(element => {
        element.textContent = count;
    });
}

// Add new comment
document.getElementById('commentForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const content = document.getElementById('commentTextarea').value.trim();
    if (!content) return;
    
    const submitBtn = document.getElementById('commentSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Posting...';
    
    fetch(`/api/comment/add/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('commentTextarea').value = '';
            document.getElementById('charCounter').textContent = '0/1000';
            showNotification(data.message, 'success');
            loadComments(currentPage);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to post comment', 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Post Comment';
    });
});

// Character counter for comment textarea
document.getElementById('commentTextarea')?.addEventListener('input', function() {
    const counter = document.getElementById('charCounter');
    counter.textContent = `${this.value.length}/1000`;
});

// Character counter for edit textarea
document.getElementById('flagReason')?.addEventListener('change', function() {
    const customReasonDiv = document.getElementById('customReasonDiv');
    if (this.value === 'Other') {
        customReasonDiv.style.display = 'block';
    } else {
        customReasonDiv.style.display = 'none';
    }
});

// Character counter for edit textarea
function setupEditCounter() {
    const editTextarea = document.getElementById('editCommentText');
    const editCounter = document.getElementById('editCharCounter');
    if (editTextarea && editCounter) {
        editTextarea.addEventListener('input', function() {
            editCounter.textContent = `${this.value.length}/1000`;
        });
    }
}

// Show flag modal
function showFlagModal(commentId) {
    document.getElementById('flagCommentId').value = commentId;
    document.getElementById('flagReason').value = '';
    document.getElementById('customReason').value = '';
    document.getElementById('customReasonDiv').style.display = 'none';
    
    const flagModal = new bootstrap.Modal(document.getElementById('flagModal'));
    flagModal.show();
}

// Submit flag
function submitFlag() {
    const commentId = document.getElementById('flagCommentId').value;
    let reason = document.getElementById('flagReason').value;
    
    if (reason === 'Other') {
        reason = document.getElementById('customReason').value.trim();
        if (!reason) {
            showNotification('Please specify a reason', 'warning');
            return;
        }
    }
    
    if (!reason) {
        showNotification('Please select a reason', 'warning');
        return;
    }
    
    fetch(`/api/comment/flag/${commentId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
            action: 'flag',
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            loadComments(currentPage);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('flagModal')).hide();
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to flag comment', 'error');
    });
}

// Perform moderation actions (unflag, hide, unhide)
function performModeration(commentId, action) {
    if (!confirm(`Are you sure you want to ${action} this comment?`)) {
        return;
    }
    
    fetch(`/api/comment/flag/${commentId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            loadComments(currentPage);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to perform action', 'error');
    });
}

// Show edit modal
function showEditModal(commentId, content) {
    document.getElementById('editCommentId').value = commentId;
    document.getElementById('editCommentText').value = content.replace(/\\'/g, "'");
    document.getElementById('editCharCounter').textContent = `${content.length}/1000`;
    
    setupEditCounter();
    
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    editModal.show();
}

// Submit edit
function submitEdit() {
    const commentId = document.getElementById('editCommentId').value;
    const content = document.getElementById('editCommentText').value.trim();
    
    if (!content) {
        showNotification('Comment cannot be empty', 'warning');
        return;
    }
    
    fetch(`/api/comment/edit/${commentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            loadComments(currentPage);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to edit comment', 'error');
    });
}

// Delete comment
function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/comment/delete/${commentId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            loadComments(currentPage);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to delete comment', 'error');
    });
}

// Update admin stats
function updateAdminStats() {
    fetch(`/api/comments/${postId}?page=1&per_page=1000`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const flagged = data.comments.filter(c => c.is_flagged).length;
                const hidden = data.comments.filter(c => c.is_hidden).length;
                
                document.getElementById('flaggedCount').textContent = flagged;
                document.getElementById('hiddenCount').textContent = hidden;
            }
        });
}

// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showNotification('Link copied to clipboard!', 'success');
    }, function(err) {
        console.error('Could not copy text: ', err);
    });
}

// Show notification
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.custom-notification');
    existingNotifications.forEach(note => note.remove());
    
    const notification = document.createElement('div');
    notification.className = `custom-notification alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            ${type === 'success' ? '<i class="fas fa-check-circle me-2"></i>' : '<i class="fas fa-exclamation-triangle me-2"></i>'}
            <span>${message}</span>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Update admin stats periodically (only for admins)
if (isAdmin) {
    setInterval(updateAdminStats, 30000);
    setTimeout(updateAdminStats, 1000);
}
</script>

<!-- Include the like.js script -->
<script src="{{ url_for('static', filename='js/like.js') }}"></script>
<!-- Include the recommend.js script -->
<script src="{{ url_for('static', filename='js/recommend.js') }}"></script>

{% endblock %}
