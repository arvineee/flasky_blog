{% extends 'base.html' %}

{% block content %}
{{ super() }}
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 fw-bold text-primary">
            <i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard
        </h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('admin.new_post') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>New Post
            </a>
            <a href="{{ url_for('main.logout') }}" class="btn btn-outline-secondary">
                <i class="fas fa-sign-out-alt me-1"></i>Logout
            </a>
        </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 row-cols-xl-5 mb-4">
        <div class="col mb-4">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">Total Users</h6>
                            <h3 class="fw-bold mb-0">{{ users|length }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">Total Posts</h6>
                            <h3 class="fw-bold mb-0">{{ posts|length }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-file-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">Subscribers</h6>
                            <h3 class="fw-bold mb-0">{{ subscriber_count }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-envelope fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-dark-50">Active Ads</h6>
                            <h3 class="fw-bold mb-0">{{ active_ads_count }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-ad fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-dark text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">Ad Revenue</h6>
                            <h3 class="fw-bold mb-0">${{ "%.2f"|format(total_ad_revenue) }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Add this after your stats cards row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Quick Statistics Overview</h5>
                    <a href="{{ url_for('advanced_protection.stats_page') }}" class="btn btn-sm btn-light">
                        View Full Stats <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h3 class="text-primary" id="stat-total-requests">{{ "{:,}".format(stats.total_requests) }}</h3>
                        <small class="text-muted">Total Requests</small>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-danger" id="stat-blocked">{{ "{:,}".format(stats.requests_blocked) }}</h3>
                        <small class="text-muted">Blocked</small>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-warning" id="stat-banned">{{ stats.currently_banned }}</h3>
                        <small class="text-muted">Banned IPs</small>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-success" id="stat-rps">{{ stats.current_rps }}</h3>
                        <small class="text-muted">Current RPS</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- API Stats Row -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 row-cols-xl-5 mb-4">
        <div class="col mb-4">
            <div class="card stat-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">Your Country</h6>
                            <h3 class="fw-bold mb-0">{{ admin_country }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-globe fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">API Keys</h6>
                            <h3 class="fw-bold mb-0">{{ api_keys_count }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-key fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">API Posts Today</h6>
                            <h3 class="fw-bold mb-0">{{ api_posts_today }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-code fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-dark-50">Active API Users</h6>
                            <h3 class="fw-bold mb-0">{{ active_api_users }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">Banned Users</h6>
                            <h3 class="fw-bold mb-0">{{ banned_users_count }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-ban fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('admin.manage_ads') }}" class="btn btn-action">
    <i class="fas fa-ad me-1"></i> Manage Ads
</a>
<a href="{{ url_for('admin.create_advanced_ad') }}" class="btn btn-action btn-primary">
    <i class="fas fa-magic me-1"></i> Create Advanced Ad
</a>
                        <a href="{{ url_for('admin.admin_traffic_stats') }}" class="btn btn-action">
                            <i class="fas fa-chart-line me-1"></i> Traffic Stats
                        </a>
                        <a href="{{ url_for('admin.manage_ads_txt') }}" class="btn btn-action">
                            <i class="fas fa-file-text me-1"></i> Manage Ads.txt
                        </a>
                        <a href="{{ url_for('admin.send_newsletter') }}" class="btn btn-action">
                            <i class="fas fa-paper-plane me-1"></i> Send Newsletter
                        </a>
                        <a href="{{ url_for('admin.manage_subscribers') }}" class="btn btn-action">
                            <i class="fas fa-user-friends me-1"></i> Subscribers
                        </a>
                        <a href="{{ url_for('admin.create_announcement') }}" class="btn btn-action">
                            <i class="fas fa-bullhorn me-1"></i> Announcement
                        </a>
                        <a href="{{ url_for('admin.upload_video') }}" class="btn btn-action">
                            <i class="fas fa-video me-1"></i> Upload Video
                        </a>
                        <a href="{{ url_for('admin.ddos_protection_management') }}" class="btn btn-action">
                            <i class="fas fa-shield-alt me-1"></i> DDoS Protection
                        </a>
                        <a href="{{ url_for('admin.manage_categories') }}" class="btn btn-action">
                            <i class="fas fa-tags me-1"></i> Manage Categories
                        </a>
                        <a href="{{ url_for('admin.api_docs') }}" class="btn btn-action">
                            <i class="fas fa-code me-1"></i> API Docs
                        </a>
                        <a href="{{ url_for('admin.manage_api_keys') }}" class="btn btn-action">
                            <i class="fas fa-key me-1"></i> API Keys
                        </a>
                        <a href="{{ url_for('advanced_protection.stats_page') }}" class="btn btn-info">
    <i class="fas fa-chart-line me-1"></i>View Detailed Statistics
</a>
                        <a href="{{ url_for('admin.manage_country_blocking') }}" class="btn btn-action">
    <i class="fas fa-globe-americas me-1"></i>Country Blocking
</a>
                        <!-- NEW: Advanced Protection Links -->
                        <a href="{{ url_for('advanced_protection.dashboard') }}" class="btn btn-action">
                            <i class="fas fa-shield-alt me-1"></i> Advanced Protection
                        </a>
                        <a href="{{ url_for('advanced_protection.dashboard') }}" class="btn btn-action">
                            <i class="fas fa-globe-americas me-1"></i> Country Management
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Security & Protection Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Advanced Security & Protection</h5>
                    <div>
                        <a href="{{ url_for('advanced_protection.dashboard') }}" class="btn btn-sm btn-light me-2">
                            <i class="fas fa-external-link-alt me-1"></i>Open Dashboard
                        </a>
                        <a href="{{ url_for('admin.ddos_protection_management') }}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-fire me-1"></i>DDoS Protection
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">üõ°Ô∏è Advanced Protection Dashboard</h5>
                                    <p class="card-text">Comprehensive security monitoring, threat protection, and real-time analytics with GeoLite2 integration.</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-danger">Security</span>
                                        <a href="{{ url_for('advanced_protection.dashboard') }}" class="btn btn-sm btn-danger">
                                            <i class="fas fa-rocket me-1"></i>Access Dashboard
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">üåç Country Management</h5>
                                    <p class="card-text">Manage allowed/blocked countries for geographic blocking using GeoLite2 database.</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-success">GeoIP</span>
                                        <a href="{{ url_for('advanced_protection.dashboard') }}" class="btn btn-sm btn-success">
                                            <i class="fas fa-cog me-1"></i>Manage Countries
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Security Quick Stats</h6>
                        <div class="row text-center">
                            <div class="col-md-3 col-6 mb-2">
                                <div class="border rounded p-2">
                                    <div class="text-primary fw-bold">Active</div>
                                    <small class="text-muted">Protection Mode</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="border rounded p-2">
                                    <div class="text-success fw-bold">{{ 'Enabled' if ddos_protection else 'Disabled' }}</div>
                                    <small class="text-muted">DDoS Protection</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="border rounded p-2">
                                    <div class="text-info fw-bold">GeoLite2</div>
                                    <small class="text-muted">Database</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="border rounded p-2">
                                    <div class="text-warning fw-bold">WAF</div>
                                    <small class="text-muted">Rules Active</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>User Management
                        <span class="badge bg-light text-dark ms-2">{{ users|length }} Users</span>
                    </h5>
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#userManagementCollapse">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="collapse show" id="userManagementCollapse">
                    <div class="card-body">
                        <!-- Search Form -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <form method="GET" action="{{ url_for('admin.admin_dashboard') }}">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Search users..." name="q" value="{{ request.args.get('q', '') }}">
                                        <button class="btn btn-primary" type="submit">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        {% if request.args.get('q') %}
                                        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary">
                                            <i class="fas fa-times"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-6 d-flex justify-content-end">
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-filter me-1"></i>Filter
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', filter='all') }}">All Users</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', filter='admins') }}">Admins Only</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', filter='banned') }}">Banned Users</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', filter='active') }}">Active Users</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- User Table -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Role</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr id="user-row-{{ user.id }}">
                                        <td>{{ user.id }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                    {{ user.username[0]|upper }}
                                                </div>
                                                {{ user.username }}
                                            </div>
                                        </td>
                                        <td>{{ user.email }}</td>
                                        <td id="user-status-{{ user.id }}">
                                            {% if user.is_banned %}
                                            <span class="badge bg-danger">Banned</span>
                                            {% else %}
                                            <span class="badge bg-success">Active</span>
                                            {% endif %}
                                        </td>
                                        <td id="user-role-{{ user.id }}">
                                            {% if user.is_admin %}
                                            <span class="badge bg-warning text-dark">Admin</span>
                                            {% else %}
                                            <span class="badge bg-secondary">User</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ user.date_r.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ url_for('admin.admin_user_action', user_id=user.id) }}" class="btn btn-outline-primary" title="Manage User">
                                                    <i class="fas fa-cog"></i>
                                                </a>
                                                
                                                <!-- Ban/Unban Button -->
                                                {% if user.is_banned %}
                                                <button type="button" class="btn btn-outline-success user-action-btn" 
                                                        data-action="unban" 
                                                        data-user-id="{{ user.id }}"
                                                        data-user-name="{{ user.username }}"
                                                        title="Unban User">
                                                    <i class="fas fa-check-circle"></i>
                                                </button>
                                                {% else %}
                                                <button type="button" class="btn btn-outline-warning user-action-btn" 
                                                        data-action="ban" 
                                                        data-user-id="{{ user.id }}"
                                                        data-user-name="{{ user.username }}"
                                                        title="Ban User">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                                {% endif %}
                                                
                                                <!-- Promote/Demote Button -->
                                                {% if user.is_admin and user.id != current_user.id and user.username != "Felix" %}
                                                <button type="button" class="btn btn-outline-secondary user-action-btn" 
                                                        data-action="demote" 
                                                        data-user-id="{{ user.id }}"
                                                        data-user-name="{{ user.username }}"
                                                        title="Demote from Admin">
                                                    <i class="fas fa-user-minus"></i>
                                                </button>
                                                {% elif not user.is_admin %}
                                                <button type="button" class="btn btn-outline-info user-action-btn" 
                                                        data-action="promote" 
                                                        data-user-id="{{ user.id }}"
                                                        data-user-name="{{ user.username }}"
                                                        title="Promote to Admin">
                                                    <i class="fas fa-user-plus"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination (if needed) -->
                        {% if users|length == 0 %}
                        <div class="text-center py-4">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No users found matching your criteria.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Post Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Post Management
                        <span class="badge bg-light text-dark ms-2">{{ posts|length }} Posts</span>
                    </h5>
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#postManagementCollapse">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="collapse show" id="postManagementCollapse">
                    <div class="card-body">
                        <!-- Search Form -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <form method="GET" action="{{ url_for('admin.admin_dashboard') }}">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Search posts by title or content..." name="post_q" value="{{ request.args.get('post_q', '') }}">
                                        <button class="btn btn-primary" type="submit">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        {% if request.args.get('post_q') %}
                                        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary">
                                            <i class="fas fa-times"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-6 d-flex justify-content-end">
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-filter me-1"></i>Filter
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', post_filter='all') }}">All Posts</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', post_filter='blocked') }}">Blocked Posts</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', post_filter='active') }}">Active Posts</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Post Table -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Author</th>
                                        <th>Category</th>
                                        <th>Date</th>
                                        <th>Views</th>
                                        <th>Likes</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for post in posts %}
                                    <tr id="post-row-{{ post.id }}">
                                        <td>{{ post.id }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if post.image_url %}
                                                <div class="post-thumbnail me-2">
                                                    <img src="{{ url_for('static', filename='images/' + post.image_url) }}" alt="{{ post.title }}" class="rounded" style="width: 40px; height: 40px; object-fit: cover;">
                                                </div>
                                                {% endif %}
                                                <div>
                                                    <div class="fw-bold">{{ post.title|truncate(50) }}</div>
                                                    <small class="text-muted">{{ post.desc|striptags|truncate(30) }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                    {{ post.author.username[0]|upper }}
                                                </div>
                                                {{ post.author.username }}
                                            </div>
                                        </td>
                                        <td>
                                            {% if post.category_obj %}
                                            <span class="badge bg-info">{{ post.category_obj.name }}</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Uncategorized</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ post.date_pub.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ post.views or 0 }}</td>
                                        <td>{{ post.like_count or 0 }}</td>
                                        <td id="post-status-{{ post.id }}">
                                            {% if post.is_blocked %}
                                            <span class="badge bg-danger">Blocked</span>
                                            {% else %}
                                            <span class="badge bg-success">Active</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ url_for('admin.see_more', post_id=post.id) }}" class="btn btn-outline-primary" title="View Post">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="{{ url_for('admin.edit_post', post_id=post.id) }}" class="btn btn-outline-info" title="Edit Post">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <!-- Delete Button -->
                                                <button type="button" class="btn btn-outline-danger post-action-btn" 
                                                        data-action="delete"
                                                        data-post-id="{{ post.id }}"
                                                        data-post-title="{{ post.title }}"
                                                        title="Delete Post">
                                                    <i class="fas fa-trash"></i>
                                                </button>

                                                <!-- Block/Unblock Button -->
                                                {% if post.is_blocked %}
                                                <button type="button" class="btn btn-outline-success post-action-btn" 
                                                        data-action="unblock"
                                                        data-post-id="{{ post.id }}"
                                                        data-post-title="{{ post.title }}"
                                                        title="Unblock Post">
                                                    <i class="fas fa-check-circle"></i>
                                                </button>
                                                {% else %}
                                                <button type="button" class="btn btn-outline-warning post-action-btn" 
                                                        data-action="block" 
                                                        data-post-id="{{ post.id }}"
                                                        data-post-title="{{ post.title }}"
                                                        title="Block Post">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination (if needed) -->
                        {% if posts|length == 0 %}
                        <div class="text-center py-4">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No posts found matching your criteria.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-code me-2"></i>API Management</h5>
                    <div>
                        <a href="{{ url_for('admin.manage_api_keys') }}" class="btn btn-sm btn-light me-2">
                            <i class="fas fa-key me-1"></i>Manage Keys
                        </a>
                        <a href="{{ url_for('admin.api_docs') }}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-book me-1"></i>API Docs
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">API Usage</h5>
                                    <p class="card-text">Manage API keys and monitor API usage statistics.</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary">{{ api_keys_count }} Active Keys</span>
                                        <a href="{{ url_for('admin.manage_api_keys') }}" class="btn btn-sm btn-primary">
                                            Manage
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">API Documentation</h5>
                                    <p class="card-text">View comprehensive documentation for the posting API.</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-info">Available</span>
                                        <a href="{{ url_for('admin.api_docs') }}" class="btn btn-sm btn-info">
                                            View Docs
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Quick API Stats</h6>
                        <div class="row">
                            <div class="col-md-3 col-6">
                                <div class="border rounded p-2 text-center">
                                    <div class="text-primary fw-bold">{{ api_posts_today }}</div>
                                    <small class="text-muted">Posts via API Today</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="border rounded p-2 text-center">
                                    <div class="text-success fw-bold">{{ api_posts_week }}</div>
                                    <small class="text-muted">Posts via API This Week</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="border rounded p-2 text-center">
                                    <div class="text-info fw-bold">{{ active_api_users }}</div>
                                    <small class="text-muted">Active API Users</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="border rounded p-2 text-center">
                                    <div class="text-warning fw-bold">{{ api_errors }}</div>
                                    <small class="text-muted">API Errors (24h)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Add this in the System Status card or create a new section -->
<div class="mt-4">
    <h6 class="mb-3">GeoIP Test</h6>
    <div class="input-group mb-3">
        <input type="text" id="testIp" class="form-control" placeholder="Enter IP to test" value="{{ request.remote_addr }}">
        <button class="btn btn-outline-info" onclick="testGeoIP()">Test Blocking</button>
    </div>
    <div id="geoipResult" class="alert alert-info" style="display: none;"></div>
</div>

<!-- Toast Notification Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="actionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title">System Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
            Action completed successfully.
        </div>
    </div>
</div>

<style>
:root {
    --primary-color: #4361ee;
    --secondary-color: #3a0ca3;
    --success-color: #2ecc71;
    --info-color: #3498db;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --light-bg: #f8f9fa;
}

body {
    background-color: #f5f7f9;
    font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
}

.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 1.5rem;
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
    padding: 1rem 1.5rem;
    font-weight: 600;
}

.stat-card {
    border-radius: 12px;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    opacity: 0.8;
}

.btn-action {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    transition: all 0.3s ease;
}

.btn-action:hover {
    background: linear-gradient(135deg, #e9ecef, #dee2e6);
    transform: translateY(-2px);
    border-color: #4361ee;
}

.table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fa;
    padding: 1rem 0.75rem;
}

.table td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
}

.badge {
    font-size: 0.75em;
    padding: 0.5em 0.75em;
    border-radius: 6px;
}

.avatar-sm {
    width: 32px;
    height: 32px;
}

.category-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.category-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-color) !important;
}

.btn-group-sm > .btn {
    padding: 0.35rem 0.5rem;
    border-radius: 6px;
}

.post-thumbnail img {
    transition: transform 0.3s ease;
}

.post-thumbnail img:hover {
    transform: scale(1.1);
}

/* API Section Styles */
.api-stats-card {
    border-left: 4px solid var(--primary-color);
}

/* Security Section Styles */
.bg-danger {
    background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
}

.bg-success {
    background: linear-gradient(135deg, #2ecc71, #27ae60) !important;
}

.btn-danger {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    border: none;
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    border: none;
    color: white;
}

.btn-danger:hover, .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .d-flex.flex-wrap {
        justify-content: center;
    }
    
    .btn-action {
        margin-bottom: 0.5rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .post-thumbnail {
        display: none;
    }
}

/* Loading spinner */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Toast
    const actionToast = new bootstrap.Toast(document.getElementById('actionToast'));
    
    // Show toast notification
    function showToast(title, message, type = 'success') {
        document.getElementById('toast-title').textContent = title;
        document.getElementById('toast-message').textContent = message;
        
        // Set toast color based on type
        const toastHeader = document.querySelector('#actionToast .toast-header');
        toastHeader.className = 'toast-header';
        if (type === 'error') {
            toastHeader.classList.add('bg-danger', 'text-white');
        } else if (type === 'warning') {
            toastHeader.classList.add('bg-warning', 'text-dark');
        } else {
            toastHeader.classList.add('bg-success', 'text-white');
        }
        
        actionToast.show();
    }
    
    // Get CSRF token for AJAX requests
    function getCSRFToken() {
        const csrfInput = document.querySelector('input[name="csrf_token"]');
        if (csrfInput) {
            return csrfInput.value;
        }
        return '';
    }
    
    // Handle user actions with AJAX
    document.querySelectorAll('.user-action-btn').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const userId = this.dataset.userId;
            const userName = this.dataset.userName;
            
            // Show loading state
            const originalHTML = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            this.disabled = true;
            
            // Determine the endpoint based on action
            let endpoint;
            switch(action) {
                case 'ban':
                    endpoint = `/admin/user/${userId}/ban`;
                    break;
                case 'unban':
                    endpoint = `/admin/user/${userId}/unban`;
                    break;
                case 'promote':
                    endpoint = `/admin/user/${userId}/promote`;
                    break;
                case 'demote':
                    endpoint = `/admin/user/${userId}/demote`;
                    break;
                default:
                    return;
            }
            
            // Create form data with CSRF token
            const formData = new FormData();
            formData.append('csrf_token', getCSRFToken());
            
            // Send AJAX request
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update UI based on action
                    updateUIAfterAction(action, userId, userName);
                    showToast('Success', data.message || 'Action completed successfully.');
                } else {
                    throw new Error(data.message || 'Action failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error', error.message || 'An error occurred. Please try again.', 'error');
            })
            .finally(() => {
                // Restore button state
                this.innerHTML = originalHTML;
                this.disabled = false;
            });
        });
    });
    
    // Update UI after successful user action
    function updateUIAfterAction(action, userId, userName) {
        const statusElement = document.getElementById(`user-status-${userId}`);
        const roleElement = document.getElementById(`user-role-${userId}`);
        const rowElement = document.getElementById(`user-row-${userId}`);
        const actionButtons = rowElement.querySelectorAll('.user-action-btn');
        
        switch(action) {
            case 'ban':
                if (statusElement) {
                    statusElement.innerHTML = '<span class="badge bg-danger">Banned</span>';
                }
                // Replace ban button with unban button
                actionButtons.forEach(btn => {
                    if (btn.dataset.action === 'ban') {
                        btn.dataset.action = 'unban';
                        btn.classList.replace('btn-outline-warning', 'btn-outline-success');
                        btn.innerHTML = '<i class="fas fa-check-circle"></i>';
                        btn.title = 'Unban User';
                    }
                });
                break;
                
            case 'unban':
                if (statusElement) {
                    statusElement.innerHTML = '<span class="badge bg-success">Active</span>';
                }
                // Replace unban button with ban button
                actionButtons.forEach(btn => {
                    if (btn.dataset.action === 'unban') {
                        btn.dataset.action = 'ban';
                        btn.classList.replace('btn-outline-success', 'btn-outline-warning');
                        btn.innerHTML = '<i class="fas fa-ban"></i>';
                        btn.title = 'Ban User';
                    }
                });
                break;
                
            case 'promote':
                if (roleElement) {
                    roleElement.innerHTML = '<span class="badge bg-warning text-dark">Admin</span>';
                }
                // Replace promote button with demote button
                actionButtons.forEach(btn => {
                    if (btn.dataset.action === 'promote') {
                        btn.dataset.action = 'demote';
                        btn.classList.replace('btn-outline-info', 'btn-outline-secondary');
                        btn.innerHTML = '<i class="fas fa-user-minus"></i>';
                        btn.title = 'Demote from Admin';
                    }
                });
                break;
                
            case 'demote':
                if (roleElement) {
                    roleElement.innerHTML = '<span class="badge bg-secondary">User</span>';
                }
                // Replace demote button with promote button
                actionButtons.forEach(btn => {
                    if (btn.dataset.action === 'demote') {
                        btn.dataset.action = 'promote';
                        btn.classList.replace('btn-outline-secondary', 'btn-outline-info');
                        btn.innerHTML = '<i class="fas fa-user-plus"></i>';
                        btn.title = 'Promote to Admin';
                    }
                });
                break;
        }
    }
    
    // Handle post actions with AJAX
    document.querySelectorAll('.post-action-btn').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const postId = this.dataset.postId;
            const postTitle = this.dataset.postTitle;
            
            // Confirmation for delete action
            if (action === 'delete') {
                if (!confirm(`Are you sure you want to delete the post "${postTitle}"? This action cannot be undone.`)) {
                    return;
                }
            }
            
            // Show loading state
            const originalHTML = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            this.disabled = true;
            
            // Determine the endpoint based on action
            let endpoint;
            switch(action) {
                case 'block':
                    endpoint = `/admin/post/${postId}/block`;
                    break;
                case 'unblock':
                    endpoint = `/admin/post/${postId}/unblock`;
                    break;
                case 'delete':
                    endpoint = `/admin/post/${postId}/delete`;
                    break;
                default:
                    return;
            }
            
            // Create form data with CSRF token
            const formData = new FormData();
            formData.append('csrf_token', getCSRFToken());
            
            // Send AJAX request
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (action === 'delete') {
                        // Remove the post row from the table
                        const postRow = document.getElementById(`post-row-${postId}`);
                        if (postRow) {
                            postRow.remove();
                        }
                    } else {
                        // Update UI based on action
                        updatePostUIAfterAction(action, postId, postTitle);
                    }
                    showToast('Success', data.message || 'Action completed successfully.');
                } else {
                    throw new Error(data.message || 'Action failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error', error.message || 'An error occurred. Please try again.', 'error');
            })
            .finally(() => {
                // Restore button state
                this.innerHTML = originalHTML;
                this.disabled = false;
            });
        });
    });
    
    // Update UI after successful post action
    function updatePostUIAfterAction(action, postId, postTitle) {
        const statusElement = document.getElementById(`post-status-${postId}`);
        const rowElement = document.getElementById(`post-row-${postId}`);
        const actionButtons = rowElement.querySelectorAll('.post-action-btn');
        
        switch(action) {
            case 'block':
                if (statusElement) {
                    statusElement.innerHTML = '<span class="badge bg-danger">Blocked</span>';
                }
                // Replace block button with unblock button
                actionButtons.forEach(btn => {
                    if (btn.dataset.action === 'block') {
                        btn.dataset.action = 'unblock';
                        btn.classList.replace('btn-outline-warning', 'btn-outline-success');
                        btn.innerHTML = '<i class="fas fa-check-circle"></i>';
                        btn.title = 'Unblock Post';
                    }
                });
                break;
                
            case 'unblock':
                if (statusElement) {
                    statusElement.innerHTML = '<span class="badge bg-success">Active</span>';
                }
                // Replace unblock button with block button
                actionButtons.forEach(btn => {
                    if (btn.dataset.action === 'unblock') {
                        btn.dataset.action = 'block';
                        btn.classList.replace('btn-outline-success', 'btn-outline-warning');
                        btn.innerHTML = '<i class="fas fa-ban"></i>';
                        btn.title = 'Block Post';
                    }
                });
                break;
        }
    }
    
    // Check if there are any flash messages to show
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                showToast('{{ category|title }}', '{{ message }}', '{{ category }}');
            {% endfor %}
        {% endif %}
    {% endwith %}
});
// Add to your existing JavaScript in dashboard.html
function testGeoIP() {
    const ip = document.getElementById('testIp').value;
    const resultDiv = document.getElementById('geoipResult');
    
    fetch(`/admin/debug/geoip/${ip}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                resultDiv.className = 'alert alert-warning';
                resultDiv.innerHTML = `‚ö†Ô∏è ${data.error}`;
            } else {
                resultDiv.className = 'alert ' + (data.would_be_blocked ? 'alert-danger' : 'alert-success');
                resultDiv.innerHTML = `
                    <strong>IP:</strong> ${data.ip}<br>
                    <strong>Country:</strong> ${data.country_name} (${data.country_code})<br>
                    <strong>Database:</strong> ${data.database_type || 'GeoLite2-Country'}<br>
                    <strong>Geo Blocking Enabled:</strong> ${data.geo_blocking_enabled}<br>
                    <strong>Blocked Countries:</strong> ${data.blocked_countries.join(', ') || 'None'}<br>
                    <strong>Allowed Countries:</strong> ${data.allowed_countries.join(', ') || 'All'}<br>
                    <strong>Status:</strong> ${data.would_be_blocked ? '‚ùå WOULD BE BLOCKED' : '‚úÖ WOULD BE ALLOWED'}
                `;
            }
            resultDiv.style.display = 'block';
        })
        .catch(error => {
            resultDiv.className = 'alert alert-danger';
            resultDiv.innerHTML = `Error: ${error.message}`;
            resultDiv.style.display = 'block';
        });
}
<script>
// Real-time stats update
function updateQuickStats() {
    fetch('/advanced-protection/admin/dashboard/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the quick stats
                document.getElementById('stat-total-requests').textContent = 
                    data.stats.total_requests.toLocaleString();
                document.getElementById('stat-blocked').textContent = 
                    data.stats.requests_blocked.toLocaleString();
                document.getElementById('stat-banned').textContent = 
                    data.stats.currently_banned;
                document.getElementById('stat-rps').textContent = 
                    data.stats.current_rps;
                
                console.log('Stats updated:', data.stats);
            }
        })
        .catch(error => console.error('Error updating stats:', error));
}

// Update stats every 10 seconds
setInterval(updateQuickStats, 10000);
</script>
</script>
{% endblock %}
