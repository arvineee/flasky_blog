{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 fw-bold text-primary">
            <i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard
        </h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('admin.new_post') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>New Post
            </a>
            <a href="{{ url_for('main.logout') }}" class="btn btn-outline-secondary">
                <i class="fas fa-sign-out-alt me-1"></i>Logout
            </a>
        </div>
    </div>

    <!-- Quick Stats Row -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 row-cols-xl-5 mb-4">
        <div class="col mb-4">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">Total Users</h6>
                            <h3 class="fw-bold mb-0">{{ users|length }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">Total Posts</h6>
                            <h3 class="fw-bold mb-0">{{ posts|length }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-file-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">Subscribers</h6>
                            <h3 class="fw-bold mb-0">{{ subscriber_count }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-envelope fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-dark-50">Banned Users</h6>
                            <h3 class="fw-bold mb-0">{{ banned_users_count }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-ban fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col mb-4">
            <div class="card stat-card bg-dark text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title text-white-50">API Keys</h6>
                            <h3 class="fw-bold mb-0">{{ api_keys_count }}</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-key fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <div class="col mb-4">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="card-title text-white-50">Your Country</h6>
                        <h3 class="fw-bold mb-0">{{ admin_country }}</h3>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-globe fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    </div>

    <!-- Quick Actions Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('admin.admin_traffic_stats') }}" class="btn btn-action">
                            <i class="fas fa-chart-line me-1"></i> Traffic Stats
                        </a>
                        <a href="{{ url_for('admin.manage_ads_txt') }}" class="btn btn-action">
                            <i class="fas fa-file-text me-1"></i> Manage Ads.txt
                        </a>
                        <a href="{{ url_for('admin.send_newsletter') }}" class="btn btn-action">
                            <i class="fas fa-paper-plane me-1"></i> Send Newsletter
                        </a>
                        <a href="{{ url_for('admin.manage_subscribers') }}" class="btn btn-action">
                            <i class="fas fa-user-friends me-1"></i> Subscribers
                        </a>
                        <a href="{{ url_for('admin.create_announcement') }}" class="btn btn-action">
                            <i class="fas fa-bullhorn me-1"></i> Announcement
                        </a>
                        <a href="{{ url_for('admin.upload_video') }}" class="btn btn-action">
                            <i class="fas fa-video me-1"></i> Upload Video
                        </a>
                        <a href="{{ url_for('admin.ddos_protection_management') }}" class="btn btn-action">
                            <i class="fas fa-shield-alt me-1"></i> DDoS Protection
                        </a>
                        <a href="{{ url_for('advanced_protection.dashboard') }}" class="btn btn-action">
                            <i class="fas fa-user-shield me-1"></i> Advanced Protection
                        </a>
                        <a href="{{ url_for('admin.manage_categories') }}" class="btn btn-action">
                            <i class="fas fa-tags me-1"></i> Manage Categories
                        </a>
                        <a href="{{ url_for('admin.api_docs') }}" class="btn btn-action">
                            <i class="fas fa-code me-1"></i> API Docs
                        </a>
                        <a href="{{ url_for('admin.manage_api_keys') }}" class="btn btn-action">
                            <i class="fas fa-key me-1"></i> API Keys
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>User Management
                        <span class="badge bg-light text-dark ms-2">{{ users|length }} Users</span>
                    </h5>
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#userManagementCollapse">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="collapse show" id="userManagementCollapse">
                    <div class="card-body">
                        <!-- Search Form -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <form method="GET" action="{{ url_for('admin.admin_dashboard') }}">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Search users..." name="q" value="{{ request.args.get('q', '') }}">
                                        <button class="btn btn-primary" type="submit">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        {% if request.args.get('q') %}
                                        <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary">
                                            <i class="fas fa-times"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </form>
                            </div>
                            <div class="col-md-6 d-flex justify-content-end">
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-filter me-1"></i>Filter
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', filter='all') }}">All Users</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', filter='admins') }}">Admins Only</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', filter='banned') }}">Banned Users</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('admin.admin_dashboard', filter='active') }}">Active Users</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- User Table -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Role</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr id="user-row-{{ user.id }}">
                                        <td>{{ user.id }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                    {{ user.username[0]|upper }}
                                                </div>
                                                {{ user.username }}
                                            </div>
                                        </td>
                                        <td>{{ user.email }}</td>
                                        <td id="user-status-{{ user.id }}">
                                            {% if user.is_banned %}
                                            <span class="badge bg-danger">Banned</span>
                                            {% else %}
                                            <span class="badge bg-success">Active</span>
                                            {% endif %}
                                        </td>
                                        <td id="user-role-{{ user.id }}">
                                            {% if user.is_admin %}
                                            <span class="badge bg-warning text-dark">Admin</span>
                                            {% else %}
                                            <span class="badge bg-secondary">User</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ user.date_r.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ url_for('admin.admin_user_action', user_id=user.id) }}" class="btn btn-outline-primary" title="Manage User">
                                                    <i class="fas fa-cog"></i>
                                                </a>
                                                
                                                <!-- Ban/Unban Button -->
                                                {% if user.is_banned %}
                                                <button type="button" class="btn btn-outline-success user-action-btn" 
                                                        data-action="unban" 
                                                        data-user-id="{{ user.id }}"
                                                        data-user-name="{{ user.username }}"
                                                        title="Unban User">
                                                    <i class="fas fa-check-circle"></i>
                                                </button>
                                                {% else %}
                                                <button type="button" class="btn btn-outline-warning user-action-btn" 
                                                        data-action="ban" 
                                                        data-user-id="{{ user.id }}"
                                                        data-user-name="{{ user.username }}"
                                                        title="Ban User">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                                {% endif %}
                                                
                                                <!-- Promote/Demote Button -->
                                                {% if user.is_admin and user.id != current_user.id and user.username != "Felix" %}
                                                <button type="button" class="btn btn-outline-secondary user-action-btn" 
                                                        data-action="demote" 
                                                        data-user-id="{{ user.id }}"
                                                        data-user-name="{{ user.username }}"
                                                        title="Demote from Admin">
                                                    <i class="fas fa-user-minus"></i>
                                                </button>
                                                {% elif not user.is_admin %}
                                                <button type="button" class="btn btn-outline-info user-action-btn" 
                                                        data-action="promote" 
                                                        data-user-id="{{ user.id }}"
                                                        data-user-name="{{ user.username }}"
                                                        title="Promote to Admin">
                                                    <i class="fas fa-user-plus"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination (if needed) -->
                        {% if users|length == 0 %}
                        <div class="text-center py-4">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No users found matching your criteria.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Management Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-code me-2"></i>API Management</h5>
                    <div>
                        <a href="{{ url_for('admin.manage_api_keys') }}" class="btn btn-sm btn-light me-2">
                            <i class="fas fa-key me-1"></i>Manage Keys
                        </a>
                        <a href="{{ url_for('admin.api_docs') }}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-book me-1"></i>API Docs
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">API Usage</h5>
                                    <p class="card-text">Manage API keys and monitor API usage statistics.</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary">{{ api_keys_count }} Active Keys</span>
                                        <a href="{{ url_for('admin.manage_api_keys') }}" class="btn btn-sm btn-primary">
                                            Manage
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">API Documentation</h5>
                                    <p class="card-text">View comprehensive documentation for the posting API.</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-info">Available</span>
                                        <a href="{{ url_for('admin.api_docs') }}" class="btn btn-sm btn-info">
                                            View Docs
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Quick API Stats</h6>
                        <div class="row">
                            <div class="col-md-3 col-6">
                                <div class="border rounded p-2 text-center">
                                    <div class="text-primary fw-bold">{{ api_posts_today }}</div>
                                    <small class="text-muted">Posts via API Today</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="border rounded p-2 text-center">
                                    <div class="text-success fw-bold">{{ api_posts_week }}</div>
                                    <small class="text-muted">Posts via API This Week</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="border rounded p-2 text-center">
                                    <div class="text-info fw-bold">{{ active_api_users }}</div>
                                    <small class="text-muted">Active API Users</small>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="border rounded p-2 text-center">
                                    <div class="text-warning fw-bold">{{ api_errors }}</div>
                                    <small class="text-muted">API Errors (24h)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="actionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">System Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                Action completed successfully.
            </div>
        </div>
    </div>

</div>

<style>
:root {
    --primary-color: #4361ee;
    --secondary-color: #3a0ca3;
    --success-color: #2ecc71;
    --info-color: #3498db;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --light-bg: #f8f9fa;
}

body {
    background-color: #f5f7f9;
    font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
}

.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 1.5rem;
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
    padding: 1rem 1.5rem;
    font-weight: 600;
}

.stat-card {
    border-radius: 12px;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    opacity: 0.8;
}

.btn-action {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    transition: all 0.3s ease;
}

.btn-action:hover {
    background: linear-gradient(135deg, #e9ecef, #dee2e6);
    transform: translateY(-2px);
    border-color: #4361ee;
}

.table th {
    border-top: none;
    font-weight: 600;
    background-color: #f8f9fa;
    padding: 1rem 0.75rem;
}

.table td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
}

.badge {
    font-size: 0.75em;
    padding: 0.5em 0.75em;
    border-radius: 6px;
}

.avatar-sm {
    width: 32px;
    height: 32px;
}

.category-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.category-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-color) !important;
}

.btn-group-sm > .btn {
    padding: 0.35rem 0.5rem;
    border-radius: 6px;
}

/* API Section Styles */
.api-stats-card {
    border-left: 4px solid var(--primary-color);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .d-flex.flex-wrap {
        justify-content: center;
    }
    
    .btn-action {
        margin-bottom: 0.5rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
}

/* Loading spinner */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Toast
    const actionToast = new bootstrap.Toast(document.getElementById('actionToast'));
    
    // Show toast notification
    function showToast(title, message, type = 'success') {
        document.getElementById('toast-title').textContent = title;
        document.getElementById('toast-message').textContent = message;
        
        // Set toast color based on type
        const toastHeader = document.querySelector('#actionToast .toast-header');
        if (type === 'error') {
            toastHeader.classList.add('bg-danger', 'text-white');
            toastHeader.classList.remove('bg-success', 'bg-warning');
        } else if (type === 'warning') {
            toastHeader.classList.add('bg-warning', 'text-dark');
            toastHeader.classList.remove('bg-success', 'bg-danger');
        } else {
            toastHeader.classList.add('bg-success', 'text-white');
            toastHeader.classList.remove('bg-danger', 'bg-warning');
        }
        
        actionToast.show();
    }
    
    // Handle user actions with AJAX
    document.querySelectorAll('.user-action-btn').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const userId = this.dataset.userId;
            const userName = this.dataset.userName;
            
            // Show loading state
            const originalHTML = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            this.disabled = true;
            
            // Determine the endpoint based on action
            let endpoint;
            switch(action) {
                case 'ban':
                    endpoint = `/admin/user/${userId}/ban`;
                    break;
                case 'unban':
                    endpoint = `/admin/user/${userId}/unban`;
                    break;
                case 'promote':
                    endpoint = `/admin/user/${userId}/promote`;
                    break;
                case 'demote':
                    endpoint = `/admin/user/${userId}/demote`;
                    break;
                default:
                    return;
            }
            
            // Send AJAX request
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update UI based on action
                    updateUIAfterAction(action, userId, userName);
                    showToast('Success', data.message || 'Action completed successfully.');
                } else {
                    throw new Error(data.message || 'Action failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error', error.message || 'An error occurred. Please try again.', 'error');
            })
            .finally(() => {
                // Restore button state
                this.innerHTML = originalHTML;
                this.disabled = false;
            });
        });
    });
    
    // Update UI after successful action
    function updateUIAfterAction(action, userId, userName) {
        const statusElement = document.getElementById(`user-status-${userId}`);
        const roleElement = document.getElementById(`user-role-${userId}`);
        const actionButtons = document.querySelectorAll(`#user-row-${userId} .user-action-btn`);
        
        switch(action) {
            case 'ban':
                if (statusElement) {
                    statusElement.innerHTML = '<span class="badge bg-danger">Banned</span>';
                }
                // Replace ban button with unban button
                actionButtons.forEach(btn => {
                    if (btn.dataset.action === 'ban') {
                        btn.dataset.action = 'unban';
                        btn.classList.replace('btn-outline-warning', 'btn-outline-success');
                        btn.innerHTML = '<i class="fas fa-check-circle"></i>';
                        btn.title = 'Unban User';
                    }
                });
                break;
                
            case 'unban':
                if (statusElement) {
                    statusElement.innerHTML = '<span class="badge bg-success">Active</span>';
                }
                // Replace unban button with ban button
                actionButtons.forEach(btn => {
                    if (btn.dataset.action === 'unban') {
                        btn.dataset.action = 'ban';
                        btn.classList.replace('btn-outline-success', 'btn-outline-warning');
                        btn.innerHTML = '<i class="fas fa-ban"></i>';
                        btn.title = 'Ban User';
                    }
                });
                break;
                
            case 'promote':
                if (roleElement) {
                    roleElement.innerHTML = '<span class="badge bg-warning text-dark">Admin</span>';
                }
                // Replace promote button with demote button
                actionButtons.forEach(btn => {
                    if (btn.dataset.action === 'promote') {
                        btn.dataset.action = 'demote';
                        btn.classList.replace('btn-outline-info', 'btn-outline-secondary');
                        btn.innerHTML = '<i class="fas fa-user-minus"></i>';
                        btn.title = 'Demote from Admin';
                    }
                });
                break;
                
            case 'demote':
                if (roleElement) {
                    roleElement.innerHTML = '<span class="badge bg-secondary">User</span>';
                }
                // Replace demote button with promote button
                actionButtons.forEach(btn => {
                    if (btn.dataset.action === 'demote') {
                        btn.dataset.action = 'promote';
                        btn.classList.replace('btn-outline-secondary', 'btn-outline-info');
                        btn.innerHTML = '<i class="fas fa-user-plus"></i>';
                        btn.title = 'Promote to Admin';
                    }
                });
                break;
        }
    }
});
</script>
{% endblock %}
